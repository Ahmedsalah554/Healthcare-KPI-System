// ==================== ุงูุจูุงูุงุช ุงูุญููููุฉ ====================

// ูุฆุงุช ุงููุคุดุฑุงุช ุงูุญููููุฉ (15 ูุฆุฉ) - ููุณูุง
const kpiCategories = {
    WFM: { name: "ุงูููู ุงูุจุดุฑูุฉ", count: 22, color: "#0ea5e9", icon: "fas fa-users" },
    UTZ: { name: "ุงุณุชุฎุฏุงู ุงูุทุงูุฉ", count: 15, color: "#3b82f6", icon: "fas fa-bed" },
    MP: { name: "ุฌูุฏุฉ ุงูุฎุฏูุฉ", count: 19, color: "#ef4444", icon: "fas fa-stethoscope" },
    ST: { name: "ุงูุจููุฉ ุงูุชุญุชูุฉ", count: 4, color: "#f59e0b", icon: "fas fa-building" },
    FM: { name: "ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ", count: 2, color: "#8b5cf6", icon: "fas fa-money-bill-wave" },
    IMT: { name: "ุงููุนูููุงุช ุงูุทุจูุฉ", count: 6, color: "#06b6d4", icon: "fas fa-file-medical" },
    MM: { name: "ุฅุฏุงุฑุฉ ุงูุฏูุงุก", count: 3, color: "#ec4899", icon: "fas fa-pills" },
    LAB: { name: "ุงููุนูู", count: 2, color: "#84cc16", icon: "fas fa-flask" },
    DF: { name: "ุฅุฏุงุฑุฉ ุงูุฃุฏููุฉ", count: 6, color: "#f97316", icon: "fas fa-prescription-bottle" },
    PCC: { name: "ุฑุนุงูุฉ ุงููุฑุถู", count: 7, color: "#6366f1", icon: "fas fa-hand-holding-heart" },
    INT: { name: "ุงููุจุงุฏุฑุงุช", count: 7, color: "#14b8a6", icon: "fas fa-bullhorn" },
    PS: { name: "ุณูุงูุฉ ุงููุฑุถู", count: 12, color: "#eab308", icon: "fas fa-shield-alt" },
    IPC: { name: "ููุงูุญุฉ ุงูุนุฏูู", count: 8, color: "#a855f7", icon: "fas fa-virus-slash" },
    OHS: { name: "ุงูุตุญุฉ ุงูููููุฉ", count: 8, color: "#06b6d4", icon: "fas fa-hard-hat" },
    PHC: { name: "ุงูุฑุนุงูุฉ ุงูุฃูููุฉ", count: 41, color: "#22c55e", icon: "fas fa-clinic-medical" }
};

// ๐ **ููุง ุจุฏุงูุฉ ุงูุชุนุฏูู ุจูุงุกู ุนูู ุชุญููู ุงูุชุตููู ูู ุงูููู**
// ุณุฃูุดุฆ ูุตูููุฉ ูุคุดุฑุงุช ุชุนูุณ ุงูุชุตููู ุงูุตุญูุญ ุญุณุจ ุงูุฃููุงู

const allKPIs = [
    // ==================== ูุฆุฉ WFM ====================
    {
        code: "WFM-01",
        name: "ูุณุจุฉ ุชูููุฐ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงููุฏุฑุฌุฉ ุจุงูุฎุทุฉ",
        category: "WFM",
        formula: "(ุฅุฌูุงูู ุนุฏุฏ ุงูุฏูุฑุงุช ุงููููุฐุฉ ูุนููุงู ร 100) รท ุฅุฌูุงูู ุนุฏุฏ ุงูุฏูุฑุงุช ุงููุฏุฑุฌุฉ ุจุงูุฎุทุฉ",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงููููุฐุฉ ูุนููุงู",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฏูุฑุงุช ุงูุบูุฑ ูุฏุฑุฌุฉ ุจุงูุฎุทุฉ - ุงูุฏูุฑุงุช ุบูุฑ ุงูููุชููุฉ",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงููุฏุฑุฌุฉ ุจุงูุฎุทุฉ",
        denominatorHelp: "ูุง ููุฌุฏ",
        calculation: "(ุงูุจุณุท ร 100) / ุงูููุงู",
        unit: "%",
        target: 90,
        // โ **ุงูุชุตููู ุงูุฌุฏูุฏ ุจูุงุกู ุนูู ุงูููู:**
        facilityTypes: ["hospital", "unit", "center"], // ููุฌููุน
        isCritical: false
    },
    {
        code: "WFM-02",
        name: "ูุณุจุฉ ุงูุงูุชุฒุงู ุจุงูุญุถูุฑ ููุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        category: "WFM",
        formula: "(ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุงูุชุฒููุง ุจุงูุญุถูุฑ ร 100) รท ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงููุณุชูุฏููู",
        numerator: "ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุงูุชุฒููุง ุจุงูุญุถูุฑ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฐูู ูู ูุณุชููููุง ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงููุณุชูุฏููู",
        denominatorHelp: "ูุง ููุฌุฏ",
        calculation: "(ุงูุจุณุท ร 100) / ุงูููุงู",
        unit: "%",
        target: 85,
        facilityTypes: ["hospital", "unit", "center"], // ููุฌููุน
        isCritical: false
    },
    {
        code: "WFM-03",
        name: "ูุณุจุฉ ุงุฌุชูุงุฒ ุงููุชุฏุฑุจูู ููุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        category: "WFM",
        formula: "(ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุงุฌุชุงุฒูุง ุงูุชูููู ุงูููุงุฆู ร 100) รท ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุญุถุฑูุง",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุงุฌุชุงุฒูุง ุงูุชูููู ุงูููุงุฆู",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฐูู ูู ูุณุชููููุง ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ุงูุฐูู ุญุถุฑูุง",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฐูู ูู ูุณุชููููุง ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        calculation: "(ุงูุจุณุท ร 100) / ุงูููุงู",
        unit: "%",
        target: 90,
        facilityTypes: ["hospital", "unit", "center"], // ููุฌููุน
        isCritical: false
    },
    {
        code: "WFM-04",
        name: "ูุชูุณุท ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูุชู ุญุตู ุนูููุง ูู ููุธู ุณูููุงู",
        category: "WFM",
        formula: "ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ูู ุฌููุน ุงูุฏูุฑุงุช ุงููููุฐุฉ รท ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุงููุชุฏุฑุจูู ูู ุฌููุน ุงูุฏูุฑุงุช ุงููููุฐุฉ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฐูู ูู ูุณุชููููุง ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฌุฏุฏ (3 ุดููุฑ)",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ุฏูุฑุฉ/ููุธู",
        target: 2,
        facilityTypes: ["hospital", "unit", "center"], // ููุฌููุน
        isCritical: false
    },
    {
        code: "WFM-05",
        name: "ูุณุจุฉ ุงูุนุงูููู ุงูุตุญููู ุงููุฏุฑุจูู ุนูู ุงูุฅูุนุงุด ุงูููุจู ุงูุฑุฆูู (BLS)",
        category: "WFM",
        formula: "(ุนุฏุฏ ุงูุนุงูููู ุงูุตุญููู ุงููุฏุฑุจูู ุนูู BLS ร 100) รท ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู ุงูุตุญููู ุจุงูููุดุฃุฉ",
        numerator: "ุนุฏุฏ ุงูุนุงูููู ุงูุตุญููู ุงููุฏุฑุจูู ุนูู BLS",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงููุดุงุฑููู ุงูุฐูู ูู ูุฌุชุงุฒูุง ุงูุชุฏุฑูุจ ุจูุฌุงุญ - ุงููุชุฏุฑุจูู ุจุฌูุงุช ุบูุฑ ูุนุชูุฏุฉ - ุงููุชุฏุฑุจูู ุงูุฐูู ูุถู ุนูู ุชุฏุฑูุจูู ุฃูุซุฑ ูู ุณูุชูู",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู ุงูุตุญููู ุจุงูููุดุฃุฉ",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฌุฏุฏ (3 ุดููุฑ)",
        calculation: "(ุงูุจุณุท ร 100) / ุงูููุงู",
        unit: "%",
        target: 80,
        facilityTypes: ["hospital"], // โ **ูููุณุชุดููุงุช ููุท**
        isCritical: true
    },
    {
        code: "WFM-06",
        name: "ูุณุจุฉ ุงูุนุงูููู ุงููุฏุฑุจูู ุนูู ุงูุญูุงูุฉ ุงููุฏููุฉ ุนู ุทุฑูู ุงูุฏูุงุน ุงููุฏูู",
        category: "WFM",
        formula: "(ุนุฏุฏ ุงูุนุงูููู ุงููุฏุฑุจูู ุนูู ุงูุญูุงูุฉ ุงููุฏููุฉ ร 100) รท ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู ุจุงูููุดุฃุฉ",
        numerator: "ุนุฏุฏ ุงูุนุงูููู ุงููุฏุฑุจูู ุนูู ุงูุญูุงูุฉ ุงููุฏููุฉ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงููุดุงุฑููู ุงูุฐูู ูู ูุฌุชุงุฒูุง ุงูุชุฏุฑูุจ ุจูุฌุงุญ - ุงููุชุฏุฑุจูู ุจุฌูุงุช ุบูุฑ ูุนุชูุฏุฉ - ุงููุชุฏุฑุจูู ุงูุฐูู ูุถู ุนูู ุชุฏุฑูุจูู ุฃูุซุฑ ูู ุณูุชูู",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุนุงูููู ุจุงูููุดุฃุฉ",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุนุงูููู ุงูุฌุฏุฏ (3 ุดููุฑ)",
        calculation: "(ุงูุจุณุท ร 100) / ุงูููุงู",
        unit: "%",
        target: 70,
        facilityTypes: ["hospital", "unit", "center"], // ููุฌููุน
        isCritical: false
    },
    // ==================== ูุคุดุฑุงุช ูููุณุชุดูู ููุท ====================
    {
        code: "WFM-12",
        name: "ุชูุงุณุจ ุนุฏุฏ ุงูุชูุฑูุถ ุงูู ุนุฏุฏ ุฃุณุฑุฉ ุงูุฑุนุงูุฉ ุงููุฑูุฒุฉ",
        category: "WFM",
        formula: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุงูุฑุนุงูุฉ ุงููุฑูุฒุฉ รท ุฅุฌูุงูู ุฃุณุฑุฉ ุงูุฑุนุงูุฉ ุงููุฑูุฒุฉ",
        numerator: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุงูุฑุนุงูุฉ ุงููุฑูุฒุฉ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฑุงุฏ ุงูุชูุฑูุถ ุชุญุช ุงูุชุฏุฑูุจ",
        denominator: "ุฅุฌูุงูู ุฃุณุฑุฉ ุงูุฑุนุงูุฉ ุงููุฑูุฒุฉ",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุงุณุฑุฉ ุฎุงุฑุฌ ุงูุฎุฏูุฉ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ููุฑุถ/ุณุฑูุฑ",
        target: 0.5,
        facilityTypes: ["hospital"], // โ **ูููุณุชุดููุงุช ููุท**
        isCritical: true
    },
    {
        code: "WFM-14",
        name: "ุชูุงุณุจ ุนุฏุฏ ุงูุชูุฑูุถ ุงูู ุนุฏุฏ ุฃุณุฑุฉ ุงูุฏุงุฎูู",
        category: "WFM",
        formula: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุงูุฃูุณุงู ุงูุฏุงุฎููุฉ รท ุฅุฌูุงูู ุนุฏุฏ ุฃุณุฑุฉ ุงูุฏุงุฎูู",
        numerator: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุงูุฃูุณุงู ุงูุฏุงุฎููุฉ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฑุงุฏ ุงูุชูุฑูุถ ุชุญุช ุงูุชุฏุฑูุจ",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุฃุณุฑุฉ ุงูุฏุงุฎูู",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงูุงุณุฑุฉ ุฎุงุฑุฌ ุงูุฎุฏูุฉ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ููุฑุถ/ุณุฑูุฑ",
        target: 0.2,
        facilityTypes: ["hospital"], // โ **ูููุณุชุดููุงุช ููุท**
        isCritical: true
    },
    {
        code: "WFM-19",
        name: "ุชูุงุณุจ ุนุฏุฏ ุงูุชูุฑูุถ ุงูู ุงูุนูุงุฏุงุช ุงูุฎุงุฑุฌูุฉ",
        category: "WFM",
        formula: "ุฅุฌูุงูู ุนุฏุฏ ุชูุฑูุถ ุงูุนูุงุฏุงุช รท ุนุฏุฏ ุบุฑู ุงูุนูุงุฏุงุช",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุชูุฑูุถ ุงูุนูุงุฏุงุช",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฑุงุฏ ุงูุชูุฑูุถ ุชุญุช ุงูุชุฏุฑูุจ",
        denominator: "ุนุฏุฏ ุบุฑู ุงูุนูุงุฏุงุช",
        denominatorHelp: "ูุง ููุฌุฏ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ููุฑุถ/ุบุฑูุฉ",
        target: 1.5,
        facilityTypes: ["hospital"], // โ **ูููุณุชุดููุงุช ููุท**
        isCritical: false
    },
    {
        code: "WFM-20",
        name: "ุชูุงุณุจ ุนุฏุฏ ุงูุชูุฑูุถ ุงูู ุบุฑู ูุณู ุงูุทูุงุฑุฆ",
        category: "WFM",
        formula: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุจูุณู ุงูุทูุงุฑุฆ รท ุนุฏุฏ ุบุฑู ุงูุงุณุชูุจุงู ูุงูุทูุงุฑุฆ",
        numerator: "ูุชูุณุท ุนุฏุฏ ุชูุฑูุถ ูุงูุดูุช ุจูุณู ุงูุทูุงุฑุฆ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฑุงุฏ ุงูุชูุฑูุถ ุชุญุช ุงูุชุฏุฑูุจ",
        denominator: "ุนุฏุฏ ุบุฑู ุงูุงุณุชูุจุงู ูุงูุทูุงุฑุฆ",
        denominatorHelp: "ูุง ููุฌุฏ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ููุฑุถ/ุบุฑูุฉ",
        target: 1.2,
        facilityTypes: ["hospital"], // โ **ูููุณุชุดููุงุช ููุท**
        isCritical: true
    },
    // ==================== ูุคุดุฑุงุช ูููุญุฏุงุช ููุท ====================
    {
        code: "WFM-11",
        name: "ุชูุงุณุจ ุนุฏุฏ ุงูุชูุฑูุถ ุฅูู ุนุฏุฏ ูุงูููุงุช ุงูุบุณูู ุงููููู",
        category: "WFM",
        formula: "ุฅุฌูุงูู ุนุฏุฏ ุชูุฑูุถ ุงูุบุณูู ุงููููู รท ุนุฏุฏ ูุฑุถู ุงูุบุณูู ุงููููู",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุชูุฑูุถ ุงูุบุณูู ุงููููู",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุฑุงุฏ ุงูุชูุฑูุถ ุชุญุช ุงูุชุฏุฑูุจ",
        denominator: "ุนุฏุฏ ูุฑุถู ุงูุบุณูู ุงููููู",
        denominatorHelp: "ุงููุณุชุจุนุฏ: ุงููุงูููุงุช ุฎุงุฑุฌ ุงูุฎุฏูุฉ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ููุฑุถ/ูุฑูุถ",
        target: 0.3,
        facilityTypes: ["unit", "center"], // โ **ููููุญุฏุงุช ูุงููุฑุงูุฒ ููุท**
        isCritical: false
    },
    // ==================== ูุคุดุฑุงุช ูููุฑุงูุฒ ููุท ====================
    {
        code: "PHC-01",
        name: "ุชูุงุณุจ ุนุฏุฏ ุฃุทุจุงุก ุงูุฃุณุฑุฉ : ุนุฏุฏ ุงูุฃุณุฑ/ุงูุฃูุฑุงุฏ",
        category: "PHC",
        formula: "ุฅุฌูุงูู ุนุฏุฏ ุฃุทุจุงุก ุงูุฃุณุฑุฉ รท ุฅุฌูุงูู ุนุฏุฏ ุงูุฃูุฑุงุฏ ุฃู ุงูุฃุณุฑ ุงููุณุฌููู",
        numerator: "ุฅุฌูุงูู ุนุฏุฏ ุฃุทุจุงุก ุงูุฃุณุฑุฉ",
        numeratorHelp: "ุงููุณุชุจุนุฏ: ุงูุงุฎุตุงุฆููู ูู ุชุฎุตุตุงุช ุฃุฎุฑู",
        denominator: "ุฅุฌูุงูู ุนุฏุฏ ุงูุฃูุฑุงุฏ ุฃู ุงูุฃุณุฑ ุงููุณุฌููู",
        denominatorHelp: "ูุง ููุฌุฏ",
        calculation: "ุงูุจุณุท / ุงูููุงู",
        unit: "ุทุจูุจ/ูุฑุฏ",
        target: 0.002,
        facilityTypes: ["center"], // โ **ูููุฑุงูุฒ ููุท**
        isCritical: false
    },
    // ... ูููุฐุง ููู ุงููุคุดุฑุงุช ุงูุจุงููุฉ
];

// ==================== ุฅุถุงูุฉ ูุชุบูุฑุงุช ุฌุฏูุฏุฉ ====================
let currentFacility = {
    id: 1,
    name: "ูุณุชุดูู ุงููุงูุฑุฉ ุงููุฑูุฒู",
    type: "hospital" // hospital, unit, center
};

let enteredData = {};
let currentCategory = "WFM";

// ==================== ุฅุถุงูุฉ ูุธููุฉ ุชุบููุฑ ููุน ุงูููุดุฃุฉ ====================
function changeFacilityType(type) {
    currentFacility.type = type;
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ููุน ุงูููุดุฃุฉ
    const facilityName = {
        hospital: "ูุณุชุดูู",
        unit: "ูุญุฏุฉ ุตุญูุฉ",
        center: "ูุฑูุฒ ุตุญู"
    }[type];
    
    document.querySelector('.facility-info div:first-child').innerHTML = 
        `<i class="fas fa-hospital"></i> ${currentFacility.name} (${facilityName})`;
    
    // ุชุญุฏูุซ ุนุฏุฏ ุงููุคุดุฑุงุช ุงููุชุงุญุฉ
    const availableCount = allKPIs.filter(kpi => 
        kpi.facilityTypes.includes(type)
    ).length;
    
    document.querySelector('.facility-info div:nth-child(2)').textContent = 
        `ููุน ุงูููุดุฃุฉ: ${facilityName} | ุงููุคุดุฑุงุช ุงููุชุงุญุฉ: ${availableCount} ูุคุดุฑ`;
    
    // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุจููุจุงุช ูุงููุคุดุฑุงุช
    loadTabs();
    loadIndicators();
}

// ==================== ุชุนุฏูู ุฏุงูุฉ loadTabs ====================
function loadTabs() {
    const tabsContainer = document.getElementById('kpiTabs');
    tabsContainer.innerHTML = '';
    
    Object.keys(kpiCategories).forEach(categoryId => {
        const category = kpiCategories[categoryId];
        
        // ุญุณุงุจ ุนุฏุฏ ุงููุคุดุฑุงุช ุงููุชุงุญุฉ ููุฐู ุงูููุดุฃุฉ
        const availableKPIs = allKPIs.filter(kpi => 
            kpi.category === categoryId && 
            kpi.facilityTypes.includes(currentFacility.type)
        ).length;
        
        if (availableKPIs === 0) return; // ูุง ุชุนุฑุถ ุชุจููุจ ุจุฏูู ูุคุดุฑุงุช
        
        const tab = document.createElement('button');
        tab.className = `tab-btn ${categoryId === currentCategory ? 'active' : ''}`;
        tab.dataset.category = categoryId;
        tab.innerHTML = `
            <i class="${category.icon}"></i>
            ${category.name}
            <span style="background: ${category.color}22; color: ${category.color}; padding: 1px 6px; border-radius: 10px; font-size: 11px;">
                ${availableKPIs}
            </span>
        `;
        
        tab.addEventListener('click', () => {
            currentCategory = categoryId;
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadIndicators();
        });
        
        tabsContainer.appendChild(tab);
    });
}

// ==================== ุชุนุฏูู ุฏุงูุฉ loadIndicators ====================
function loadIndicators() {
    const container = document.getElementById('indicatorsContainer');
    
    // ููุชุฑุฉ ุงููุคุดุฑุงุช ุญุณุจ ุงููุฆุฉ ูููุน ุงูููุดุฃุฉ
    const filteredKPIs = allKPIs.filter(kpi => 
        kpi.category === currentCategory && 
        kpi.facilityTypes.includes(currentFacility.type)
    );
    
    // ุชุญุฏูุซ ุงูุนุฏุฏ ุงูุฅุฌูุงูู
    document.getElementById('totalCount').textContent = filteredKPIs.length;
    
    if (filteredKPIs.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                <h3 style="margin-bottom: 8px;">ูุง ุชูุฌุฏ ูุคุดุฑุงุช</h3>
                <p>ูุง ุชูุฌุฏ ูุคุดุฑุงุช ูู ูุฆุฉ ${kpiCategories[currentCategory]?.name} ูุชุงุญุฉ ูููุน ููุดุฃุชู.</p>
                <button onclick="showAllKPIs()" style="margin-top: 15px; padding: 8px 16px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-eye"></i> ุนุฑุถ ุฌููุน ุงููุคุดุฑุงุช
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    filteredKPIs.forEach(kpi => {
        const data = enteredData[kpi.code] || {};
        const status = getIndicatorStatus(data);
        
        // ุฅุถุงูุฉ ุจุงุฏุฆุฉ ุญุฑุฌุฉ ุฅุฐุง ูุงู ุงููุคุดุฑ ุญุณุงุณ
        const criticalBadge = kpi.isCritical ? 
            `<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-right: 8px;">ุญุฑุฌ</span>` : '';
        
        html += `
            <div class="indicator-card ${status}" id="card-${kpi.code}">
                <div class="indicator-header">
                    <div style="flex: 1;">
                        <div class="indicator-code">
                            ${criticalBadge}
                            ${kpi.code}
                        </div>
                        <div class="indicator-name">${kpi.name}</div>
                        <div class="indicator-formula">${kpi.formula}</div>
                    </div>
                    <div class="indicator-status ${getStatusClass(status)}">
                        ${getStatusText(status)}
                    </div>
                </div>
                
                <div class="input-row">
                    <!-- ุงูุจุณุท -->
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-arrow-up" style="color: #22c55e"></i>
                            ุงูุจุณุท
                        </label>
                        <input type="number" 
                               class="num-input" 
                               id="num-${kpi.code}"
                               placeholder="${kpi.numerator}"
                               value="${data.numerator || ''}"
                               step="${kpi.unit === '%' ? '0.01' : '1'}"
                               oninput="updateIndicator('${kpi.code}')">
                        <div class="input-help">
                            <div class="help-text">${kpi.numeratorHelp}</div>
                            <button class="help-btn" onclick="toggleHelp('${kpi.code}-num')">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ุงูููุงู -->
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-arrow-down" style="color: #ef4444"></i>
                            ุงูููุงู
                        </label>
                        <input type="number" 
                               class="num-input" 
                               id="den-${kpi.code}"
                               placeholder="${kpi.denominator}"
                               value="${data.denominator || ''}"
                               step="${kpi.unit === '%' ? '0.01' : '1'}"
                               oninput="updateIndicator('${kpi.code}')">
                        <div class="input-help">
                            <div class="help-text">${kpi.denominatorHelp}</div>
                            <button class="help-btn" onclick="toggleHelp('${kpi.code}-den')">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ุงููุชูุฌุฉ -->
                ${data.result ? `
                    <div class="result-box">
                        <div class="result-content">
                            <div>
                                <div style="font-size: 12px; color: #64748b;">ุงููุชูุฌุฉ</div>
                                <div class="result-value">${data.result} ${kpi.unit}</div>
                            </div>
                            <div class="result-status ${getResultStatusClass(data.result, kpi.target)}">
                                ${getResultStatusText(data.result, kpi.target)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
    updateEnteredCount();
}

// ==================== ุฅุถุงูุฉ ุฏุงูุฉ ูุนุฑุถ ุฌููุน ุงููุคุดุฑุงุช ====================
function showAllKPIs() {
    // ูุฐุง ุณูุนุฑุถ ุฌููุน ุงููุคุดุฑุงุช ุญุชู ุงูุชู ูุง ุชูุทุจู ูุน ููู ุฎูููุฉ ูุฎุชูู
    const allKPIsForCurrentCategory = allKPIs.filter(kpi => 
        kpi.category === currentCategory
    );
    
    const container = document.getElementById('indicatorsContainer');
    let html = '';
    
    allKPIsForCurrentCategory.forEach(kpi => {
        const isApplicable = kpi.facilityTypes.includes(currentFacility.type);
        const data = enteredData[kpi.code] || {};
        const status = getIndicatorStatus(data);
        
        html += `
            <div class="indicator-card ${status} ${!isApplicable ? 'not-applicable' : ''}" 
                 id="card-${kpi.code}"
                 style="${!isApplicable ? 'opacity: 0.6; background: #f8fafc;' : ''}">
                <div class="indicator-header">
                    <div style="flex: 1;">
                        <div class="indicator-code">
                            ${!isApplicable ? '<span style="background: #94a3b8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-right: 8px;">ุบูุฑ ูุทุจู</span>' : ''}
                            ${kpi.code}
                        </div>
                        <div class="indicator-name">${kpi.name}</div>
                        <div class="indicator-formula">${kpi.formula}</div>
                    </div>
                    ${!isApplicable ? 
                        '<div style="font-size: 12px; color: #64748b;">ูุฐุง ุงููุคุดุฑ ุบูุฑ ูุทุจู ูููุน ููุดุฃุชู</div>' : 
                        `<div class="indicator-status ${getStatusClass(status)}">
                            ${getStatusText(status)}
                        </div>`
                    }
                </div>
                
                ${isApplicable ? `
                <div class="input-row">
                    <!-- ุงูุจุณุท -->
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-arrow-up" style="color: #22c55e"></i>
                            ุงูุจุณุท
                        </label>
                        <input type="number" 
                               class="num-input" 
                               id="num-${kpi.code}"
                               placeholder="${kpi.numerator}"
                               value="${data.numerator || ''}"
                               step="${kpi.unit === '%' ? '0.01' : '1'}"
                               oninput="updateIndicator('${kpi.code}')">
                        <div class="input-help">
                            <div class="help-text">${kpi.numeratorHelp}</div>
                            <button class="help-btn" onclick="toggleHelp('${kpi.code}-num')">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ุงูููุงู -->
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-arrow-down" style="color: #ef4444"></i>
                            ุงูููุงู
                        </label>
                        <input type="number" 
                               class="num-input" 
                               id="den-${kpi.code}"
                               placeholder="${kpi.denominator}"
                               value="${data.denominator || ''}"
                               step="${kpi.unit === '%' ? '0.01' : '1'}"
                               oninput="updateIndicator('${kpi.code}')">
                        <div class="input-help">
                            <div class="help-text">${kpi.denominatorHelp}</div>
                            <button class="help-btn" onclick="toggleHelp('${kpi.code}-den')">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${data.result && isApplicable ? `
                    <div class="result-box">
                        <div class="result-content">
                            <div>
                                <div style="font-size: 12px; color: #64748b;">ุงููุชูุฌุฉ</div>
                                <div class="result-value">${data.result} ${kpi.unit}</div>
                            </div>
                            <div class="result-status ${getResultStatusClass(data.result, kpi.target)}">
                                ${getResultStatusText(data.result, kpi.target)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ==================== ุฅุถุงูุฉ ุฒุฑ ุชุบููุฑ ุงูููุดุฃุฉ ุฅูู Header ====================
// ุฃุถู ูุฐุง ุงูููุฏ ูู ุฏุงูุฉ init() ุฃู ูู ููุงู ููุงุณุจ
function addFacilitySwitcher() {
    const headerTop = document.querySelector('.header-top');
    
    const switcher = document.createElement('div');
    switcher.style.display = 'flex';
    switcher.style.gap = '8px';
    switcher.innerHTML = `
        <button onclick="changeFacilityType('hospital')" 
                style="padding: 6px 12px; background: ${currentFacility.type === 'hospital' ? '#0ea5e9' : '#e2e8f0'}; color: ${currentFacility.type === 'hospital' ? 'white' : '#475569'}; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
            <i class="fas fa-hospital"></i> ูุณุชุดูู
        </button>
        <button onclick="changeFacilityType('unit')" 
                style="padding: 6px 12px; background: ${currentFacility.type === 'unit' ? '#3b82f6' : '#e2e8f0'}; color: ${currentFacility.type === 'unit' ? 'white' : '#475569'}; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
            <i class="fas fa-clinic-medical"></i> ูุญุฏุฉ
        </button>
        <button onclick="changeFacilityType('center')" 
                style="padding: 6px 12px; background: ${currentFacility.type === 'center' ? '#22c55e' : '#e2e8f0'}; color: ${currentFacility.type === 'center' ? 'white' : '#475569'}; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
            <i class="fas fa-home"></i> ูุฑูุฒ
        </button>
    `;
    
    headerTop.appendChild(switcher);
}

// ==================== ุชุญุฏูุซ ุฏุงูุฉ init ====================
function init() {
    addFacilitySwitcher();
    loadTabs();
    loadIndicators();
    loadFromStorage();
    updateProgress();
}
